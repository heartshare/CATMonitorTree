# CATMonitorTree
CAT监控技术


![](https://i.imgur.com/60hUSij.png)

###服务端设计

![](https://i.imgur.com/GdARcGR.png)

<pre>
     CAT是一个实时和接近全量的监控系统，它侧重于对Java应用的监控，除了与点评RPC组件融合的很好之外，他将会能与
     Spring、MyBatis、Dubbo 等框架以及Log4j 等结合，不久将会支持PHP、C++、Go等多语言应用，基本接入了美团点评
     上海侧所有核心应用。目前在中间件（MVC、RPC、数据库、缓存等）框架中得到广泛应用，为美团点评各业务线提供系统的
     性能指标、健康状况、监控告警等，在微服务监控领域也是非常有用的一套组件。

     Cat系统的特性
          1)实时处理：信息的价值会随时间锐减，尤其是事故处理过程中。
          2)全量数据：最开始的设计目标就是全量采集，全量的好处有很多。
          3)高可用：所有应用都倒下了，需要监控还站着，并告诉工程师发生了什么，做到故障还原和问题定位。
          5)故障容忍：CAT本身故障不应该影响业务正常运转，CAT挂了，应用不该受影响，只是监控能力暂时减弱。
          6)高吞吐：要想还原真相，需要全方位地监控和度量，必须要有超强的处理吞吐能力。
          7)可扩展：支持分布式、跨IDC部署，横向扩展的监控系统。
          8)不保证可靠：允许消息丢失，这是一个很重要的trade-off，目前CAT服务端可以做到4个9的可靠性，可靠系统
                       和不可靠性系统的设计差别非常大。

     CAT支持的监控消息类型包括：
          1)Transaction: 适合记录跨越系统边界的程序访问行为,比如远程调用，数据库调用，也适合执行时间较长的业
                        务逻辑监控，Transaction用来记录一段代码的执行时间和次数。
          2)Event:用来记录一件事发生的次数，比如记录系统异常，它和transaction相比缺少了时间的统计，开销比
                  transaction要小。
          3)Heartbeat 表示程序内定期产生的统计信息, 如CPU%, MEM%, 连接池状态, 系统负载等。
          5)Metric 用于记录业务指标、指标可能包含对一个指标记录次数、记录平均值、记录总和，业务指标最低统计粒度为1分钟。
          6)Trace 用于记录基本的trace信息，类似于log4j的info信息，这些信息仅用于查看一些相关信息

      消息树
          CAT监控系统将每次URL、Service的请求内部执行情况都封装为一个完整的消息树、消息树可能包括Transaction、Event、
          Heartbeat、Metric和Trace信息，各个消息树之间，通过 rootMessageId以及parentMessageId串联起来，形成整个
          调用链条。
</pre>

![](https://i.imgur.com/FQlqGQl.png)

<pre>
客户端设计

	 CAT客户端在收集端数据方面使用ThreadLocal（线程局部变量），是线程本地变量，也可以称之为线程本地存储。其实
     ThreadLocal的功用非常简单，就是为每一个使用该变量的线程都提供一个变量值的副本，属于Java中一种较为特殊的
     线程绑定机制，每一个线程都可以独立地改变自己的副本，不会和其它线程的副本冲突。
	
	 在监控场景下，为用户提供服务都是Web容器，比如TomCAT或者Jetty，后端的RPC服务端比如Dubbo或者Pigeon，也都
     是基于线程池来实现的。业务方在处理业务逻辑时基本都是在一个线程内部调用后端服务、数据库、缓存等，将这些数据拿
     回来再进行业务逻辑封装，最后将结果展示给用户。所以将所有的监控请求作为一个监控上下文存入线程变量就非常合适。
	
	
	 如上图所示，业务执行业务逻辑的时候，就会把此次请求对应的监控存放于线程上下文中，存于上下文的其实是一个监控
     树的结构。在最后业务线程执行结束时，将监控对象存入一个异步内存队列中，CAT有个消费线程将队列内的数据异步发送
     到服务端。
</pre>

<pre>
序列化和通信
     序列化和通信是整个客户端包括服务端性能里面很关键的一个环节。

     1)CAT序列化协议是自定义序列化协议，自定义序列化协议相比通用序列化协议要高效很多，这个在大规模数据实时处理
      场景下还是非常有必要的。
     2)CAT通信是基于Netty来实现的NIO的数据传输
</pre>

<pre>
CAT服务端在整个实时处理中，基本上实现了全异步化处理。
     1）消息接受是基于Netty的NIO实现。
     2）消息接受到服务端就存放内存队列，然后程序开启一个线程会消费这个消息做消息分发。
     3）每个消息都会有一批线程并发消费各自队列的数据，以做到消息处理的隔离。
     5）消息存储是先存入本地磁盘，然后异步上传到HDFS文件，这也避免了强依赖HDFS。
</pre>